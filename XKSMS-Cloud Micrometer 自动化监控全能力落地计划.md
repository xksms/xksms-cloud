# 🚀《XKSMS-Cloud Micrometer 自动化监控全能力落地计划》

## 一、计划目标

本计划旨在通过一系列有组织的、循序渐进的实践冲刺，将 Micrometer 提供的所有核心自动化监控能力（Binders）全面、深入地集成到 `xksms-cloud` 项目中。计划完成后，我们的平台将具备对 JVM、系统、中间件、Web
服务器及客户端的全方位、标准化监控能力。

## 二、核心原则

* **实践驱动**：每个监控能力都必须在真实或模拟的业务场景中进行编码、部署和验证。
* **先易后难**：从最基础、最通用的监控开始，逐步深入到更复杂、更专业的领域。
* **验证闭环**：每个冲刺任务都必须以“在 Prometheus 端点看到预期指标”作为完成标准。
* **文档沉淀**：将关键指标和观察发现，反向补充到各模块的 `README.md` 中。

---

## 📅 **冲刺排期 (Sprint Planning)**

### **Sprint 1：奠定基石 (环境与基础监控)**

**目标**：验证并开启最基础的、与业务逻辑无关的底层监控。这是所有监控的基石。

| 任务单元          | 实施模块                | 行动计划                                                                                | 需验证的关键指标                                                   |
|:--------------|:--------------------|:------------------------------------------------------------------------------------|:-----------------------------------------------------------|
| **1. JVM 监控** | `xksms-user-biz`    | 1. 确认 `spring-boot-starter-actuator` 依赖存在。<br>2. 启动服务，访问 `/actuator/prometheus` 端点。 | `jvm.memory.used`, `jvm.gc.pause`, `jvm.threads.live`      |
| **2. 系统监控**   | `xksms-user-biz`    | (同上，JVM Binders 默认会带上 System Binders)                                               | `system.cpu.usage`, `process.uptime`, `process.files.open` |
| **3. 日志监控**   | `xksms-starter-log` | 1. 确认 `logback-classic` 依赖存在。<br>2. 在 `xksms-user-biz` 中故意打印不同级别的日志（ERROR, WARN）。   | `logback.events.total` (并检查 `level` 标签)                    |

---

### **Sprint 2：核心依赖 (Web 与数据源监控)**

**目标**：打通对服务“入口”（Web服务器）和“生命线”（数据库）的监控。

| 任务单元             | 实施模块             | 行动计划                                                                          | 需验证的关键指标                                                                                   |
|:-----------------|:-----------------|:------------------------------------------------------------------------------|:-------------------------------------------------------------------------------------------|
| **1. Tomcat 监控** | `xksms-gateway`  | 1. 确认 `spring-boot-starter-webflux` 存在。<br>2. 多次访问网关的任意路由接口。                  | `tomcat.sessions.active.current`, `tomcat.threads.busy`                                    |
| **2. 数据库连接池**    | `xksms-user-biz` | 1. (未来) 引入 `xksms-starter-datasource` 并配置一个数据源。<br>2. 实现一个简单的数据库查询接口。         | `hikaricp.connections.active`, `hikaricp.connections.idle`, `hikaricp.connections.pending` |
| **3. 缓存监控**      | `xksms-user-biz` | 1. 引入 `spring-boot-starter-cache` 和 `caffeine` 依赖。<br>2. 配置并使用一个 Caffeine 缓存。 | `cache.gets` (并检查 `result=hit/miss` 标签), `cache.puts`, `cache.evictions`                   |

---

### **Sprint 3：服务间调用 (HTTP 客户端监控)**

**目标**：实现对服务间调用（出站请求）的链路监控，这是微服务拓扑可观测的关键。

| 任务单元                 | 实施模块              | 行动计划                                                                                                                           | 需验证的关键指标                                                  |
|:---------------------|:------------------|:-------------------------------------------------------------------------------------------------------------------------------|:----------------------------------------------------------|
| **1. OpenFeign 客户端** | `xksms-order-biz` | 1. 定义一个 `UserFeignClient` 调用 `xksms-user-biz` 的接口。<br>2. 确保 OpenFeign 的依赖中包含了 Apache HttpClient 或 OkHttp。<br>3. 多次发起 Feign 调用。 | `http.client.requests` (检查 `uri`, `method`, `status` 等标签) |
| **2. WebClient 客户端** | `xksms-gateway`   | 1. 在网关的某个 Filter 中，使用 `WebClient` 调用一个外部天气 API。<br>2. 多次触发该 Filter。                                                            | (同上) `http.client.requests`                               |

---

### **Sprint 4：专项突破 (消息与特定中间件)**

**目标**：针对项目中可能用到的专业中间件，进行专项监控集成。

| 任务单元                   | 实施模块                  | 行动计划                                                                                                       | 需验证的关键指标                                                         |
|:-----------------------|:----------------------|:-----------------------------------------------------------------------------------------------------------|:-----------------------------------------------------------------|
| **1. Kafka 监控**        | `xksms-notify-biz`    | 1. 引入 `spring-kafka` 依赖。<br>2. 实现一个简单的 Kafka 生产者和消费者。<br>3. 发送并消费消息。                                       | `kafka.producer.record.send.total`, `kafka.consumer.fetch.total` |
| **2. MongoDB 监控**      | `xksms-file-biz`      | 1. 引入 `spring-boot-starter-data-mongodb`。<br>2. 实现对 MongoDB 的一次增删改查操作。                                     | `mongodb.driver.pool.size`, `mongodb.driver.commands` (Timer)    |
| **3. Commons Pool 监控** | `xksms-starter-redis` | 1. (未来) 在封装 Redis Starter 时，使用 `commons-pool2` 管理 Jedis/Lettuce 连接。<br>2. 注入一个 `CommonsPool2Metrics` Bean。 | `commons.pool2.num.idle`, `commons.pool2.num.waiters`            |

---

## 三、成果验收

* **代码层面**：所有相关的 Starter 和业务模块都包含了必要的依赖和配置。
* **监控层面**：能够在 Grafana 中，基于本次计划集成的所有指标，创建一份《XKSMS-Cloud 核心服务健康状况》的综合 Dashboard。
* **文档层面**：完成《XKSMS-Cloud 核心监控指标字典》，作为未来运维和告警配置的依据。

---

### **《XKSMS-Cloud 核心服务健康状况》的综合 Dashboard**

#### 1. 它是什么？

**它不是一个技术，而是一个产品，一个为我们团队（开发、运维、甚至产品经理）打造的“作战指挥室”。**

在技术上，它是一个（或一组）在 **Grafana** 中创建的可视化仪表盘。这个仪表盘的数据源，正是我们计划采集的所有 Micrometer 指标，这些指标由 **Prometheus** 负责存储。

#### 2. 它应该长什么样？

想象一下，我们打开一个网页，就能立刻看到 `xksms-cloud` 所有核心服务的“心电图”：

* **全局概览区 (第一层)**：
    * **核心业务指标**：比如“过去1小时总订单量”、“当前在线用户数”、“支付成功率”。
    * **系统健康状态**：一个红绿灯矩阵，清晰地显示 `xksms-user`, `xksms-order`, `xksms-gateway` 等每个服务当前是否健康。

* **基础设施层 (第二层)**：
    * **JVM 健康状况**：所有服务的堆内存使用率、GC 暂停时间、线程数等指标的趋势图，让我们能一眼看出哪个服务可能存在内存泄漏或线程阻塞。
    * **CPU/系统负载**：展示所有服务所在容器的 CPU 使用率，帮助我们判断资源是否充足。

* **服务性能层 (第三层)**：
    * **API (HTTP Server) 性能**：展示所有核心 API 接口的 **QPS (每秒请求数)**、**延迟 (Latency)**（包括平均值、TP95、TP99）和**错误率**。我们可以快速定位到哪个接口是系统的性能瓶颈。
    * **依赖性能 (HTTP Client)**：展示服务间调用的性能。比如，“订单服务调用用户服务的平均耗时是多少？”，让我们能看清整个调用链路的健康状况。
    * **数据库/缓存性能**：数据库连接池的活跃数、等待数；缓存的命中率等。

这个 Dashboard 将我们采集到的、散落在 Prometheus 中的成千上万个时间序列数据，**加工、提炼、并以最直观的方式呈现出来**，让我们能在一分钟内对整个平台的健康状况做出准确判断。

---

### **XKSMS-Cloud 核心监控指标字典**

#### 1. 它是什么？

**如果说 Dashboard 是“作战地图”，那“指标字典”就是这张地图的“图例和说明书”。**

它是一份 **Markdown 文档**，是我们团队共同维护的知识库。这份文档将系统性地、无遗漏地记录下我们在 `xksms-cloud` 中定义和使用的所有核心监控指标。

#### 2. 它应该包含什么？

对于我们采集的每一个重要指标（特别是我们自定义的业务指标），这份字典都应该提供清晰的说明：

| 指标名称 (Metric Name)            | 指标类型 (Type) | 标签 (Tags)                              | 业务含义说明                            | 告警建议 (SLA/SLO)                                                                        |
|:------------------------------|:------------|:---------------------------------------|:----------------------------------|:--------------------------------------------------------------------------------------|
| `xksms.user.logins.total`     | `Counter`   | `result` (success/failure)             | 统计用户登录的总次数。通过 `result` 标签区分成功与失败。 | **告警**：当 `result=failure` 的速率在5分钟内超过 50次/分钟时，触发 P3 告警。                                |
| `http.server.requests`        | `Timer`     | `uri`, `method`, `status`, `exception` | 监控所有进入服务的 HTTP 请求的耗时和频率。          | **告警**：当任意 `uri` 的 TP99 延迟持续5分钟超过 2秒时，触发 P2 告警。当 `status` 为 5xx 的错误率超过 1% 时，触发 P1 告警。 |
| `hikaricp.connections.active` | `Gauge`     | `pool` (连接池名称)                         | 监控数据库连接池中活跃连接的数量。                 | **告警**：当活跃连接数持续10分钟超过最大连接数的 90% 时，触发 P2 告警。                                           |

#### 3. 为什么它至关重要？

1. **消除知识孤岛**：它让团队里的每一个人（包括新成员）都能快速理解每个监控图表背后的业务含义，避免了“只有创造者才看得懂”的尴尬。
2. **告警配置的依据**：它是我们设置自动化告警规则（Alerting Rules）的**唯一依据**。没有清晰的定义和阈值，我们的告警就会混乱不堪，要么漏报，要么误报。
3. **驱动运维自动化**：一份好的指标字典，是未来实现 AIOps（智能运维）、自动化容量伸缩、异常自愈等高级功能的**数据基础**。

---

总而言之，**Dashboard 是我们的“眼睛”，让我们能看见系统的脉搏；而“指标字典”是我们的“大脑”，让我们能理解这些脉搏的含义**。这两者结合，才能让我们真正地驾驭我们亲手创造的这个复杂系统。