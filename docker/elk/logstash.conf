input {
  beats { port => 5044 }                       # Filebeat / Winlogbeat
  tcp   { port => 5000 codec => json_lines }   # 可选：直连 TCP(JSON)
}

filter {
  # 1) 如果 message 是 JSON，合并到顶层；不是就跳过
  json {
    source => "message"
    skip_on_invalid_json => true
  }

  # 2) 字段迁移到 ECS（不要在大括号里写注释）
  mutate {
    rename => {
      "level"       => "[log][level]"
      "logger"      => "[log][logger]"
      "thread"      => "[process][thread][name]"
      "stack_trace" => "[error][stack_trace]"
      "app_name"    => "[service][name]"
      "traceId"     => "[trace][id]"
      "spanId"      => "[span][id]"
    }
  }

  # 3) 解析自定义时间戳到 @timestamp；成功后删除原始字段
  if [timestamp] {
    date { match => ["timestamp", "ISO8601"] remove_field => ["timestamp"] }
  }

  # 4) 计算索引前缀（优先 service.name；没有则 unknown）
  mutate { add_field => { "[@metadata][index_prefix]" => "%{[service][name]}" } }
  if ![service][name] {
    mutate { update => { "[@metadata][index_prefix]" => "unknown" } }
  }

  # 仅保留核心字段，其他都删
prune {
  whitelist_names => [
    "@timestamp",
    "message",
    "[service][name]",
    "[log][level]",
    "[log][logger]",
    "[process][thread][name]",
    "[trace][id]",
    "[span][id]",
    "[error][stack_trace]",
    "[host][name]"
  ]
}

}

output {
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    index => "%{[@metadata][index_prefix]}-logs-%{+YYYY.MM.dd}"
    ilm_enabled     => false
    manage_template => false
  }
  stdout { codec => rubydebug }
}
